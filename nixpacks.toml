# Nixpacks: Nginx + PHP-FPM, root = /app/public, fallback = index.php
# Sem supervisor: start.sh sobe php-fpm em background e nginx em foreground.

[phases.setup]
nixPkgs = ["php82", "php82Packages.composer", "nginx"]

[phases.build]
cmds = [
    "composer install --no-dev --optimize-autoloader --ignore-platform-reqs",
    "mkdir -p /etc/nginx",
    "cp /assets/mime.types /assets/fastcgi_params /etc/nginx/",
    "chmod +x /assets/start.sh"
]

[start]
cmd = "/assets/start.sh"

[staticAssets]
"start.sh" = '''
#!/bin/bash
set -e
export PORT=${PORT:-3000}
export PATH="/root/.nix-profile/bin:/root/.nix-profile/sbin:/nix/var/nix/profiles/default/bin:/nix/var/nix/profiles/default/sbin:$PATH"
mkdir -p /etc/nginx
cp -f /assets/mime.types /assets/fastcgi_params /etc/nginx/ 2>/dev/null || true
sed "s/\\${PORT}/$PORT/g" /assets/nginx.template.conf > /etc/nginx.conf
php-fpm -y /assets/php-fpm.conf -F &
exec nginx -c /etc/nginx.conf -g "daemon off;"
'''

"php-fpm.conf" = '''
[www]
listen = 127.0.0.1:9000
user = nobody
group = nobody
listen.owner = nobody
listen.group = nobody
pm = dynamic
pm.max_children = 50
pm.min_spare_servers = 2
pm.max_spare_servers = 4
clear_env = no
'''

"nginx.template.conf" = '''
worker_processes 1;
daemon off;
error_log /dev/stderr info;
events { worker_connections 1024; }
http {
    include       /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log /dev/stdout;
    sendfile on;
    server {
        listen ${PORT};
        listen [::]:${PORT};
        server_name localhost;
        root /app/public;
        index index.php;
        charset utf-8;
        client_max_body_size 35M;
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }
        location ~ \\.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include /etc/nginx/fastcgi_params;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_read_timeout 300;
        }
        location ~ /\\.(?!well-known).* { deny all; }
    }
}
'''

"mime.types" = '''
types {
    text/html html htm shtml;
    text/css css;
    text/xml xml;
    image/gif gif;
    image/jpeg jpeg jpg;
    application/javascript js;
    application/json json;
    text/plain txt;
    image/png png;
    image/svg+xml svg svgz;
    image/webp webp;
    image/x-icon ico;
    font/woff woff;
    font/woff2 woff2;
    application/pdf pdf;
    application/zip zip;
    application/octet-stream bin exe dll;
    audio/mpeg mp3;
    video/mp4 mp4;
}
'''

"fastcgi_params" = '''
fastcgi_param QUERY_STRING $query_string;
fastcgi_param REQUEST_METHOD $request_method;
fastcgi_param CONTENT_TYPE $content_type;
fastcgi_param CONTENT_LENGTH $content_length;
fastcgi_param SCRIPT_NAME $fastcgi_script_name;
fastcgi_param REQUEST_URI $request_uri;
fastcgi_param DOCUMENT_URI $document_uri;
fastcgi_param DOCUMENT_ROOT $document_root;
fastcgi_param SERVER_PROTOCOL $server_protocol;
fastcgi_param REQUEST_SCHEME $scheme;
fastcgi_param HTTPS $https if_not_empty;
fastcgi_param GATEWAY_INTERFACE CGI/1.1;
fastcgi_param SERVER_SOFTWARE nginx/$nginx_version;
fastcgi_param REMOTE_ADDR $remote_addr;
fastcgi_param REMOTE_PORT $remote_port;
fastcgi_param SERVER_ADDR $server_addr;
fastcgi_param SERVER_PORT $server_port;
fastcgi_param SERVER_NAME $server_name;
fastcgi_param REDIRECT_STATUS 200;
'''
